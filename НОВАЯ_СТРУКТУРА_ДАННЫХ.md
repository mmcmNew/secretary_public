# Новая структура данных - Руководство по внедрению

## Обзор изменений

Была реализована новая система управления данными, которая разделяет:
- **Системные данные** - общие файлы для всех пользователей
- **Пользовательские данные** - индивидуальные файлы каждого пользователя

## Что было сделано

### 1. Автоматическое заполнение таблиц подписки ✅

Обновлен файл `server/app/init_subscription_data.py` с правильными данными:

**access_levels:**
- ID 1: Free (5 контейнеров, tasks + calendar)
- ID 2: Basic (10 контейнеров, tasks + calendar + memory + JournalEditor + chat)
- ID 3: Premium (-1 контейнеров, все функции)
- ID 4: Admin (-1 контейнеров, все функции + admin)

**subscription_plans:**
- ID 1: Free (0₽, уровень 1, бессрочно)
- ID 2: Basic (299₽, уровень 2, 30 дней)
- ID 3: Premium (599₽, уровень 3, 30 дней)

### 2. Новая структура папок ✅

```
data/
├── system/                     # Системные данные
│   ├── defaults/              # Файлы по умолчанию
│   │   ├── scenarios/         # Системные сценарии
│   │   └── settings/          # Системные настройки
│   └── assets/                # Системные ресурсы
│       ├── memory/            # Изображения памяти
│       ├── sounds/            # Звуки
│       └── avatars/           # Аватары
├── user_data/                 # Пользовательские данные
│   └── user_{id}/             # Папка пользователя
│       ├── scenarios/         # Пользовательские сценарии
│       ├── settings/          # Пользовательские настройки
│       ├── memory/            # Пользовательские изображения
│       ├── uploads/           # Загруженные файлы
│       └── temp/              # Временные файлы
└── logs/                      # Логи
```

### 3. Созданные файлы ✅

- `server/app/data_paths.py` - Конфигурация путей
- `server/app/user_data_manager.py` - Менеджер пользовательских данных
- `data/README.md` - Документация структуры
- `server/test_new_data_structure.py` - Тест системы
- `server/check_subscription_data.py` - Проверка подписок

### 4. Обновленные файлы ✅

- `server/app/__init__.py` - Добавлена инициализация подписок
- `server/app/main/models.py` - Добавлена инициализация рабочего пространства
- `server/app/main/routes.py` - Обновлены маршруты для новой системы

## Как использовать

### Для разработчиков

1. **Проверка системы:**
```bash
cd server
python test_new_data_structure.py
```

2. **Проверка подписок:**
```bash
cd server
python check_subscription_data.py
```

### Автоматические процессы

1. **При регистрации нового пользователя:**
   - Автоматически создается папка `user_{id}`
   - Копируются системные файлы по умолчанию
   - Создается дефолтный журнал

2. **При запросе файлов:**
   - Сначала ищется в пользовательской папке
   - Затем в системной папке
   - Возвращается 404 если не найдено

### API изменения

Маршруты остались теми же, но теперь используют новую систему:
- `/avatars/` - системные аватары
- `/sounds/` - системные звуки  
- `/memory/` - изображения памяти (пользовательские → системные)
- `/get_scenario/` - сценарии (пользовательские → системные)

## Преимущества

1. **Безопасность** - пользователи не могут изменить системные файлы
2. **Персонализация** - каждый пользователь может настроить свои данные
3. **Масштабируемость** - легко добавлять новых пользователей
4. **Обслуживание** - легко обновлять системные файлы
5. **Чистота** - системные и пользовательские данные не смешиваются

## Миграция существующих данных

Существующие файлы из `data/user_data/` были скопированы в `data/system/` как базовые системные файлы. При первом входе пользователей эти файлы будут автоматически скопированы в их личные папки.

## Следующие шаги

1. Протестировать систему в разработке
2. Убедиться, что все маршруты работают корректно
3. Проверить создание новых пользователей
4. При необходимости добавить дополнительные типы данных

## Поддержка

Если возникают проблемы:
1. Проверьте логи приложения
2. Запустите тестовые скрипты
3. Убедитесь, что папки созданы с правильными правами доступа